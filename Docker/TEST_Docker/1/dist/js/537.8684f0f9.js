"use strict";(self["webpackChunkclaimApp_web"]=self["webpackChunkclaimApp_web"]||[]).push([[537],{537:function(e,t,n){n.r(t),n.d(t,{SdkClient:function(){return o},SdkClientFactory:function(){return r}});var i=n(7327);n(7658),n(8862),n(2490),n(4514),n(3847);const s="4.2.0-SNAPSHOT";class r{constructor(){}getSdkClient(e){return new o(e)}}class o{constructor(e){(0,i.Z)(this,"socket",null),(0,i.Z)(this,"clientConfig",{iceServers:[{urls:"stun:webrtc.yaic.com.cn:59071"}],socketUrl:"",domain:"",username:"",p:"",accessId:"9da02548-00a4-b2bd-0dfe-0e7eb35ef02d",secretId:"e1c4acba-99b5-4f53-9873-42d8177d8a52",token:null,enableLog:!0,enableDebug:!1,status:!1,sdp:null,requestId:1,audioConfig:{audioElement:document.createElement("audio"),muteAudio:!1,audio:!0,video:!1}}),(0,i.Z)(this,"logger",new l(this.clientConfig.enableLog,this.clientConfig.enableDebug)),(0,i.Z)(this,"localStream",null),(0,i.Z)(this,"localPeerConnection",null),(0,i.Z)(this,"calls",{}),(0,i.Z)(this,"activeCall",{callId:null,callee:null,caller:null,createdMillis:null,ringingMillis:null,releaseMillis:null,type:null,remoteSessionDescription:null,reconnect:!1,hold:null}),(0,i.Z)(this,"clientListeners",{onConnected:null,onDisconnected:null,onConnectedFailed:null,onRegistered:null,onUnregistered:null,onReconnected:null}),(0,i.Z)(this,"callListeners",{onMessage:null,onCallStatus:null,onCallChangeConnectState:null}),Object.assign(this.clientConfig,e)}start(){let e=this;return this.socket=new WebSocket(this.clientConfig.socketUrl),new Promise(((t,n)=>{e.socket.onopen=()=>{e.logger.info("connected"),e.clientConfig.status=!0,e.auth().then((t=>{e.logger.info("send REQUEST_AUTHENTICATION success",t)})),e.clientListeners.onConnected&&e.clientListeners.onConnected()},e.socket.onmessage=({data:t})=>{const n=JSON.parse(t),i=n.code;if(i)switch(i){case g.HEART_BEAT:n.languageType=h.JAVASCRIPT,n.trafficType=u.RESPONSE,e.socket.send(JSON.stringify(n)),e.logger.debug("receive HEART_BEAT",n);break;case g.REGISTER_RESPONSE:e.logger.info("receive REGISTER_RESPONSE",n);const t=200===n.payload.code;null!=e.clientListeners.onRegistered&&e.clientListeners.onRegistered(t,n.payload),t&&e.activeCall.callId&&e.activeCall.reconnect&&e.reconnect().then((()=>{e.logger.info("reconnect success"),null!=e.clientListeners.onReconnected&&e.clientListeners.onReconnected(200===n.payload.code,n.payload.message)}));break;case g.UNREGISTER_RESPONSE:e.logger.info("receive UNREGISTER_RESPONSE",n),null!=e.clientListeners.onUnregistered&&e.clientListeners.onUnregistered(200===n.payload.code,n.payload.message);break;case g.CALL_STATUS_RESPONSE:e.logger.info("receive CALL_STATUS_RESPONSE",n),e.handleCallStatusResponse(n);break;case g.MESSAGE_REQUEST:e.logger.info("receive MESSAGE_REQUEST",n),null!=e.callListeners.onMessage&&e.callListeners.onMessage(n);break;case g.REQUEST_AUTHENTICATION:e.logger.info("receive REQUEST_AUTHENTICATION",n),e.register().then((t=>{e.logger.info("send REQUEST_REGISTER success",t)})),n.payload.iceServers&&(e.clientConfig.iceServers=[],n.payload.iceServers.forEach((t=>{e.clientConfig.iceServers.push({urls:t})})),e.logger.info("iceServers",e.clientConfig.iceServers));break;default:e.logger.warn("unknown code",n);break}else e.logger.error("unknown type",n)},e.socket.onerror=t=>(e.logger.error("connect failed",t),e.clientConfig.status=!1,null!=e.activeCall.callId&&(e.activeCall.reconnect=!0,e.start().then((()=>{e.logger.info("start reconnect")}))),e.clientListeners.onConnectedFailed&&e.clientListeners.onConnectedFailed(t),n("connect failed")),e.socket.onclose=t=>{e.logger.info("disconnected"),e.clientConfig.status=!1;let n=!1;null!=e.activeCall.callId&&(n=!0,e.activeCall.reconnect=!0,e.start().then((()=>{e.logger.info("start reconnect")}))),e.clientListeners.onDisconnected&&e.clientListeners.onDisconnected(n)}}))}stop(){let e=this;return new Promise(((t,n)=>{null!=e.activeCall.callId&&n("cannot stop , is calling"),e.socket.close(),t(!0)}))}getSdp(e=null){return new Promise((async(t,n)=>{const i=navigator.mediaDevices||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;let s=!1;if(("undefined"!==typeof MediaStreamTrack&&"getSources"in MediaStreamTrack||i&&navigator.mediaDevices.enumerateDevices)&&(s=!0),!s)return n("MediaStreamTrack not available");this.localPeerConnection=new RTCPeerConnection({iceServers:this.clientConfig.iceServers},{optional:[{RtpDataChannels:!0}]}),await i.getUserMedia({audio:this.clientConfig.audioConfig.audio,video:this.clientConfig.audioConfig.video}).then((e=>{this.logger.info("getUserMedia success",e),this.localStream=e,this.localPeerConnection.addTrack(this.localStream.getTracks()[0],this.localStream),this.localPeerConnection.ontrack=e=>{this.logger.info("Remote stream added.");const t=this.clientConfig.audioConfig.audioElement;t.srcObject=e.streams[0],t.play().then((e=>{this.logger.info("play remote audio success")}))}})),null!=e?await this.localPeerConnection.setRemoteDescription({type:"offer",sdp:e}).then((async()=>this.localPeerConnection.createAnswer().then((e=>{this.logger.info("createAnswer success"),this.clientConfig.sdp=e.sdp,this.localPeerConnection.setLocalDescription(e)})))):await this.localPeerConnection.createOffer().then((e=>{this.clientConfig.sdp=e.sdp,this.localPeerConnection.setLocalDescription(e)})),this.localPeerConnection.onicecandidate=e=>{null!=e.candidate?this.clientConfig.sdp+="a="+e.candidate.candidate+"\r\n":t(!0)}}))}auth(){const e=this;return new Promise(((t,n)=>{const i="password";let s={domain:e.clientConfig.domain,username:e.clientConfig.username,clientId:navigator.userAgent,accessId:e.clientConfig.accessId,token:e.token(),environment:{appVersion:navigator.userAgent}};s[i]=e.clientConfig.p,e.send(this.createRequest({code:g.REQUEST_AUTHENTICATION,trafficType:u.REQUEST_ASYNC,payload:s})).then((e=>{t(e)}))}))}register(){const e=this;return new Promise(((t,n)=>{e.send(this.createRequest({code:g.REGISTER_REQUEST,trafficType:u.REQUEST_ONEWAY})).then((e=>{this.logger.info("send REGISTER_REQUEST success",e),t(e)}))}))}unregister(){return this.send(this.createRequest({code:g.UNREGISTER_REQUEST,trafficType:u.REQUEST_ONEWAY})).then((e=>{this.logger.info("send UNREGISTER_REQUEST success",e)}))}call({calleeNumber:e,header:t,callListener:n}){let i=this;return new Promise(((s,r)=>{if(!e)return r("calleeNumber is required");this.getSdp().then((s=>{if(!i.clientConfig.sdp)return r("sdp is required");n&&Object.assign(i.callListeners,n);i.send(i.createRequest({code:g.NEW_CALL_REQUEST,trafficType:u.REQUEST_ONEWAY,payload:{calleeNumber:e,description:i.clientConfig.sdp,header:t}})).then((e=>{i.logger.info("send NEW_CALL_REQUEST success",e)}))}))}))}answer(e){let t=this;return new Promise(((n,i)=>{e&&Object.assign(t.callListeners,e),this.getSdp(t.activeCall.remoteSessionDescription).then((e=>t.clientConfig.sdp?t.activeCall?void t.send(t.createRequest({code:g.ANSWER_CALL_REQUEST,trafficType:u.REQUEST_ONEWAY,payload:{callId:t.activeCall.callId,localDescription:t.clientConfig.sdp}})).then((e=>{n(e)})).catch((function(){return i("answer failed")})):i("callId is required"):i("sdp is required")))}))}dtmf(e){let t=this;return new Promise(((n,i)=>{if(!e)return i("dtmf is required");t.send(t.createRequest({code:g.SEND_DTMF_REQUEST,trafficType:u.REQUEST_ONEWAY,payload:{callId:t.activeCall.callId,digits:e}})).then((e=>{n(e)})).catch((function(){return i("dtmf failed")}))}))}hold(e){return new Promise((async(t,n)=>{this.activeCall.callId||n("no active call");let i=this.clientConfig.sdp;e?(i=this.clientConfig.sdp.replaceAll("sendrecv","sendonly"),this.activeCall.hold=!0):this.activeCall.hold=!0,this.send(this.createRequest({code:g.RECONNECT_CALL_REQUEST,trafficType:u.REQUEST_ONEWAY,payload:{callId:this.activeCall.callId,localDescription:i}})).then((e=>{this.logger.info("send reconnect success",e),t(e)}))}))}mute(){const e=this;return this.localStream.getAudioTracks().forEach((function(t){t.enabled=!e.clientConfig.audioConfig.muteAudio})),this.clientConfig.audioConfig.muteAudio=!this.clientConfig.audioConfig.muteAudio,this.clientConfig.audioConfig.muteAudio}release(){let e=this;return new Promise(((t,n)=>{if(!e.activeCall)return n("no active call");e.send(e.createRequest({code:g.HANGUP_CALL_REQUEST,trafficType:u.REQUEST_ONEWAY,payload:e.activeCall.callId})).then((e=>{t(e)})).catch((function(){return n("release failed")}))}))}reconnect(){return new Promise((async(e,t)=>{this.activeCall.callId||t("no active call"),this.send(this.createRequest({code:g.RECONNECT_CALL_REQUEST,trafficType:u.REQUEST_ONEWAY,payload:{callId:this.activeCall.callId,localDescription:this.clientConfig.sdp}})).then((t=>{this.logger.info("send reconnect success",t),e(t)}))}))}send(e){let t=this;return new Promise(((n,i)=>{t.logger.info("send request",e);const s=JSON.stringify(e);if(!t.clientConfig.status)return i("socket is not connected");t.socket.send(s),n(!0)}))}setClientListener(e){let t=this;return new Promise(((n,i)=>{e?(Object.assign(t.clientListeners,e),t.logger.info("clientListeners set success",t.clientListeners),n(!0)):(t.logger.error("listeners is required"),i("listeners is required"))}))}setCallListener(e){let t=this;return new Promise(((n,i)=>{e?(Object.assign(t.callListeners,e),t.logger.info("callListeners set success",t.callListeners),n(!0)):(t.logger.error("listeners is required"),i("listeners is required"))}))}handleCallStatusResponse(e){const t=e.payload,n=t.state;Object.assign(this.activeCall,t),this.calls[t.callId]=t,n===a.RINGING?this.logger.info(a.RINGING):n===a.TALKING?(this.logger.info(a.TALKING,this.activeCall),d.OUTBOUND!==t.type||this.activeCall.reconnect||null!=this.activeCall.hold||this.localPeerConnection.setRemoteDescription({type:"answer",sdp:t.remoteSessionDescription}).then((e=>{this.logger.info(a.TALKING)})),this.activeCall.reconnect&&this.clientConfig.audioConfig.audioElement.play()):n===a.RELEASED?(this.logger.info(a.RELEASED,this.activeCall),Object.entries(this.activeCall).forEach((([e,t])=>this.activeCall[e]=null)),delete this.calls[e.payload.callId]):n===a.DELIVERED&&(this.logger.info(a.DELIVERED,this.activeCall),this.activeCall.remoteSessionDescription=t.remoteSessionDescription),null!=this.callListeners.onCallStatus&&this.callListeners.onCallStatus(200===t.code,t)}createRequest({code:e,payload:t,remark:n,properties:i,trafficType:r}){const o=new c;return o.code=e,o.requestId=this.clientConfig.requestId++,o.languageType=h.JAVASCRIPT,o.version=s,o.trafficType=r,o.opCode=f.SUCCESS,n&&(o.remark=n),i&&(o.properties=i),t&&(o.payload=t),o}token(){return this.clientConfig.token||new S.SHA256(this.clientConfig.accessId+"|"+this.clientConfig.secretId).toString()}}class l{constructor(e=!0,t=!1){(0,i.Z)(this,"enable",null),(0,i.Z)(this,"debugEnable",null),this.enable=e,this.debugEnable=t}info(...e){e&&this.enable&&(e.unshift(E()),console.log(e))}warn(...e){e&&this.enable&&(e.unshift(E()),console.warn(e))}debug(...e){e&&this.enable&&this.debugEnable&&(e.unshift(E()),console.debug(e))}error(...e){e&&this.enable&&(e.unshift(E()),console.error(e))}}class c{constructor(){(0,i.Z)(this,"code",void 0),(0,i.Z)(this,"requestId",void 0),(0,i.Z)(this,"trafficType",void 0),(0,i.Z)(this,"languageType",void 0),(0,i.Z)(this,"version",void 0),(0,i.Z)(this,"opCode",void 0),(0,i.Z)(this,"remark",void 0),(0,i.Z)(this,"properties",void 0),(0,i.Z)(this,"payload",void 0)}}const a={RINGING:"RINGING",DELIVERED:"DELIVERED",TALKING:"TALKING",RELEASED:"RELEASED"},d={OUTBOUND:"OUTBOUND",INBOUND:"INBOUND"},u={REQUEST_SYNC:"REQUEST_SYNC",REQUEST_ASYNC:"REQUEST_ASYNC",REQUEST_ONEWAY:"REQUEST_ONEWAY",RESPONSE:"RESPONSE"},h={JAVASCRIPT:"JAVASCRIPT"},g={HEART_BEAT:21,REQUEST_AUTHENTICATION:100,REGISTER_REQUEST:101,REGISTER_RESPONSE:201,UNREGISTER_REQUEST:102,UNREGISTER_RESPONSE:202,NEW_CALL_REQUEST:103,RECONNECT_CALL_REQUEST:10302,HOLD_CALL_REQUEST:10303,UN_HOLD_CALL_REQUEST:10304,SEND_DTMF_REQUEST:10305,ANSWER_CALL_REQUEST:10306,HANGUP_CALL_REQUEST:104,HANGUP_CALL_RESPONSE:204,CALL_STATUS_RESPONSE:210,MESSAGE_REQUEST:301},f={SUCCESS:0,SYSTEM_ERROR:1,SYSTEM_BUSY:2,REQUEST_CODE_NOT_SUPPORTED:3};function E(){const e=new Date(Date.now()),t=e.getUTCFullYear(),n=("0"+(e.getUTCMonth()+1)).slice(-2),i=("0"+e.getUTCDate()).slice(-2),s=("0"+(e.getUTCHours()+8)).slice(-2),r=("0"+e.getUTCMinutes()).slice(-2),o=("0"+e.getUTCSeconds()).slice(-2);return`${t}-${n}-${i} ${s}:${r}:${o}`}var S=S||function(e,t){var n={},i=n.lib={},s=function(){},r=i.Base={extend:function(e){s.prototype=this;var t=new s;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=i.WordArray=r.extend({init:function(e,n){e=this.words=e||[],this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,n=e.words,i=this.sigBytes;if(e=e.sigBytes,this.clamp(),i%4)for(var s=0;s<e;s++)t[i+s>>>2]|=(n[s>>>2]>>>24-s%4*8&255)<<24-(i+s)%4*8;else if(65535<n.length)for(s=0;s<e;s+=4)t[i+s>>>2]=n[s>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=r.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],i=0;i<t;i+=4)n.push(4294967296*e.random()|0);return new o.init(n,t)}}),l=n.enc={},c=l.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;i<e;i++){var s=t[i>>>2]>>>24-i%4*8&255;n.push((s>>>4).toString(16)),n.push((15&s).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i+=2)n[i>>>3]|=parseInt(e.substr(i,2),16)<<24-i%8*4;return new o.init(n,t/2)}},a=l.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],i=0;i<e;i++)n.push(String.fromCharCode(t[i>>>2]>>>24-i%4*8&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i++)n[i>>>2]|=(255&e.charCodeAt(i))<<24-i%4*8;return new o.init(n,t)}},d=l.Utf8={stringify:function(e){try{return decodeURIComponent(escape(a.stringify(e)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(e){return a.parse(unescape(encodeURIComponent(e)))}},u=i.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,i=n.words,s=n.sigBytes,r=this.blockSize,l=s/(4*r);l=t?e.ceil(l):e.max((0|l)-this._minBufferSize,0);if(t=l*r,s=e.min(4*t,s),t){for(var c=0;c<t;c+=r)this._doProcessBlock(i,c);c=i.splice(0,t),n.sigBytes-=s}return new o.init(c,s)},clone:function(){var e=r.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});i.Hasher=u.extend({cfg:r.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new h.HMAC.init(e,n).finalize(t)}}});var h=n.algo={};return n}(Math);(function(e){for(var t=S,n=t.lib,i=n.WordArray,s=n.Hasher,r=(n=t.algo,[]),o=[],l=function(e){return 4294967296*(e-(0|e))|0},c=2,a=0;64>a;){var d;e:{d=c;for(var u=e.sqrt(d),h=2;h<=u;h++)if(!(d%h)){d=!1;break e}d=!0}d&&(8>a&&(r[a]=l(e.pow(c,.5))),o[a]=l(e.pow(c,1/3)),a++),c++}var g=[];n=n.SHA256=s.extend({_doReset:function(){this._hash=new i.init(r.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],s=n[1],r=n[2],l=n[3],c=n[4],a=n[5],d=n[6],u=n[7],h=0;64>h;h++){if(16>h)g[h]=0|e[t+h];else{var f=g[h-15],E=g[h-2];g[h]=((f<<25|f>>>7)^(f<<14|f>>>18)^f>>>3)+g[h-7]+((E<<15|E>>>17)^(E<<13|E>>>19)^E>>>10)+g[h-16]}f=u+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&a^~c&d)+o[h]+g[h],E=((i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22))+(i&s^i&r^s&r),u=d,d=a,a=c,c=l+f|0,l=r,r=s,s=i,i=f+E|0}n[0]=n[0]+i|0,n[1]=n[1]+s|0,n[2]=n[2]+r|0,n[3]=n[3]+l|0,n[4]=n[4]+c|0,n[5]=n[5]+a|0,n[6]=n[6]+d|0,n[7]=n[7]+u|0},_doFinalize:function(){var t=this._data,n=t.words,i=8*this._nDataBytes,s=8*t.sigBytes;return n[s>>>5]|=128<<24-s%32,n[14+(s+64>>>9<<4)]=e.floor(i/4294967296),n[15+(s+64>>>9<<4)]=i,t.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=s._createHelper(n),t.HmacSHA256=s._createHmacHelper(n)})(Math)}}]);